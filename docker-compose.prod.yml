services:
  backend:
    image: ${BACKEND_IMAGE:?Set BACKEND_IMAGE to a published backend image}
    container_name: insight_backend
    env_file:
      - path: .env.production
        required: false
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-production}
      PORT: ${PORT:-8000}
      APP_MODULE: ${APP_MODULE:-app.main:app}
      WEB_CONCURRENCY: ${WEB_CONCURRENCY:-2}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      HEALTHCHECK_PATH: ${HEALTHCHECK_PATH:-/health}
      DATABASE_URL: ${DATABASE_URL:?Set DATABASE_URL to managed PostgreSQL URL}
      SQL_ECHO: ${SQL_ECHO:-false}
      DB_POOL_SIZE: ${DB_POOL_SIZE:-10}
      DB_MAX_OVERFLOW: ${DB_MAX_OVERFLOW:-20}
      DB_POOL_RECYCLE: ${DB_POOL_RECYCLE:-1800}
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    healthcheck:
      test: ["CMD", "python", "/app/scripts/healthcheck.py"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    stop_grace_period: 20s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"
